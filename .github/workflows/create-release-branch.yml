name: Create Release Branch (after staging deploy)

on:
  workflow_run:
    workflows: ["Deploy Backend (Cloudflare Workers)"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: create-release-branch-backend
  cancel-in-progress: true

jobs:
  create_release_branch:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'dev'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout dev at deployed commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Compute next release version from existing release branches
        id: ver
        env:
          GH_TOKEN: ${{ secrets.PR_BOT_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          set -euxo pipefail

          BASE_MM=$(node -p "(() => { const v=require('./package.json').version||'0.0.0'; const [M,m]=v.split('.'); return `${M}.${m}`; })()")
          echo "Base major.minor from package.json: $BASE_MM"

          REFS=$(gh api -H "Accept: application/vnd.github+json" \
            "repos/$REPO/git/matching-refs/heads/release/v" --paginate \
            | jq -r '.[].ref' || true)

          if [ -z "${REFS:-}" ]; then
            LAST="$BASE_MM.0"
          else
            LAST=$(echo "$REFS" \
              | sed -n 's#^refs/heads/release/v##p' \
              | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
              | sort -V \
              | tail -n 1)
            if [ -z "${LAST:-}" ]; then
              LAST="$BASE_MM.0"
            fi
          fi

          NEXT=$(node -p "(() => { const [M,m,p]=('$LAST').split('.').map(Number); return `${M}.${m}.${p+1}`; })()")

          echo "last=$LAST" >> $GITHUB_OUTPUT
          echo "version=$NEXT" >> $GITHUB_OUTPUT
          echo "branch=release/v$NEXT" >> $GITHUB_OUTPUT

          echo "Last release: $LAST"
          echo "Next release: $NEXT"

      - name: Create release branch (always new) at deployed SHA
        env:
          GH_TOKEN: ${{ secrets.PR_BOT_TOKEN }}
          BRANCH: ${{ steps.ver.outputs.branch }}
          SHA: ${{ github.event.workflow_run.head_sha }}
          REPO: ${{ github.repository }}
        run: |
          set -euxo pipefail

          if gh api -X GET "repos/$REPO/branches/$BRANCH" >/dev/null 2>&1; then
            echo "::error::Branch already exists unexpectedly: $BRANCH"
            exit 1
          fi

          gh api -X POST "repos/$REPO/git/refs" \
            -f ref="refs/heads/$BRANCH" \
            -f sha="$SHA"

          echo "Created $BRANCH at $SHA"
