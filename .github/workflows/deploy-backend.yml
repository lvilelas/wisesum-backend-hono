name: Deploy Frontend (Cloudflare Workers)

on:
  push:
    branches: [dev, main]

concurrency:
  group: frontend-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Usa GitHub Environments para carregar vars/secrets diferentes por branch
    environment: ${{ github.ref_name == 'main' && 'production' || 'staging' }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          set -euxo pipefail
          npm install

      - name: Validate required env for build
        run: |
          set -euxo pipefail
          test -n "${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}" || (echo "::error::Missing NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY (GitHub Environment var)" && exit 1)
          test -n "${NEXT_PUBLIC_BACKEND_URL}" || (echo "::error::Missing NEXT_PUBLIC_BACKEND_URL (GitHub Environment var)" && exit 1)
          test -n "${CLERK_SECRET_KEY}" || (echo "::error::Missing CLERK_SECRET_KEY (GitHub Environment secret)" && exit 1)
        env:
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ vars.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_BACKEND_URL: ${{ vars.NEXT_PUBLIC_BACKEND_URL }}
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}

      - name: Build Next.js
        run: |
          set -euxo pipefail
          npm run build
        env:
          ENV: ${{ vars.ENV }}
          NEXT_PUBLIC_BACKEND_URL: ${{ vars.NEXT_PUBLIC_BACKEND_URL }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ vars.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ vars.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ vars.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_CLERK_SIGN_IN_URL: ${{ vars.NEXT_PUBLIC_CLERK_SIGN_IN_URL }}
          NEXT_PUBLIC_CLERK_SIGN_UP_URL: ${{ vars.NEXT_PUBLIC_CLERK_SIGN_UP_URL }}
          NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL: ${{ vars.NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL }}
          NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL: ${{ vars.NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL }}
          NEXT_PUBLIC_STRIPE_PRICE_MONTHLY: ${{ vars.NEXT_PUBLIC_STRIPE_PRICE_MONTHLY }}
          NEXT_PUBLIC_STRIPE_PRICE_ONE_TIME: ${{ vars.NEXT_PUBLIC_STRIPE_PRICE_ONE_TIME }}

      - name: Build OpenNext (Cloudflare)
        run: |
          set -euxo pipefail

          echo "Node: $(node -v)"
          echo "NPM:  $(npm -v)"

          npx @opennextjs/cloudflare build

          echo "---- Verify OpenNext output ----"
          ls -la .open-next || true
          ls -la .open-next/assets || true

          test -d ".open-next" || (echo "::error::.open-next not generated" && exit 1)
          test -d ".open-next/assets" || (echo "::error::.open-next/assets not generated" && exit 1)
          test "$(ls -A .open-next/assets | wc -l)" -gt 0 || (echo "::error::.open-next/assets is empty" && exit 1)

      # ✅ Um único step para sincronizar TUDO que o Worker precisa em runtime (staging/prod)
      - name: Sync Worker runtime envs (Cloudflare)
        run: |
          set -euxo pipefail

          npx wrangler --version

          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            ENV="production"
          else
            ENV="staging"
          fi

          # Clerk
          echo -n "$CLERK_SECRET_KEY" | npx wrangler secret put CLERK_SECRET_KEY --env "$ENV"
          echo -n "$NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY" | npx wrangler secret put NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY --env "$ENV"

          # App / Backend URL (runtime)
          echo -n "$NEXT_PUBLIC_BACKEND_URL" | npx wrangler secret put NEXT_PUBLIC_BACKEND_URL --env "$ENV"

          # Supabase
          echo -n "$NEXT_PUBLIC_SUPABASE_URL" | npx wrangler secret put NEXT_PUBLIC_SUPABASE_URL --env "$ENV"
          echo -n "$NEXT_PUBLIC_SUPABASE_ANON_KEY" | npx wrangler secret put NEXT_PUBLIC_SUPABASE_ANON_KEY --env "$ENV"

          # Stripe (se o front usa em runtime)
          echo -n "$NEXT_PUBLIC_STRIPE_PRICE_MONTHLY" | npx wrangler secret put NEXT_PUBLIC_STRIPE_PRICE_MONTHLY --env "$ENV"
          echo -n "$NEXT_PUBLIC_STRIPE_PRICE_ONE_TIME" | npx wrangler secret put NEXT_PUBLIC_STRIPE_PRICE_ONE_TIME --env "$ENV"

          # URLs do Clerk (se o front usa em runtime)
          echo -n "$NEXT_PUBLIC_CLERK_SIGN_IN_URL" | npx wrangler secret put NEXT_PUBLIC_CLERK_SIGN_IN_URL --env "$ENV"
          echo -n "$NEXT_PUBLIC_CLERK_SIGN_UP_URL" | npx wrangler secret put NEXT_PUBLIC_CLERK_SIGN_UP_URL --env "$ENV"
          echo -n "$NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL" | npx wrangler secret put NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL --env "$ENV"
          echo -n "$NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL" | npx wrangler secret put NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL --env "$ENV"

          # Lista (debug)
          npx wrangler secret list --env "$ENV"
        env:
          # Cloudflare auth
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

          # GitHub envs (staging/production)
          ENV: ${{ vars.ENV }}
          NEXT_PUBLIC_BACKEND_URL: ${{ vars.NEXT_PUBLIC_BACKEND_URL }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ vars.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ vars.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${{ vars.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          NEXT_PUBLIC_CLERK_SIGN_IN_URL: ${{ vars.NEXT_PUBLIC_CLERK_SIGN_IN_URL }}
          NEXT_PUBLIC_CLERK_SIGN_UP_URL: ${{ vars.NEXT_PUBLIC_CLERK_SIGN_UP_URL }}
          NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL: ${{ vars.NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL }}
          NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL: ${{ vars.NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL }}
          NEXT_PUBLIC_STRIPE_PRICE_MONTHLY: ${{ vars.NEXT_PUBLIC_STRIPE_PRICE_MONTHLY }}
          NEXT_PUBLIC_STRIPE_PRICE_ONE_TIME: ${{ vars.NEXT_PUBLIC_STRIPE_PRICE_ONE_TIME }}

          # Secrets
          CLERK_SECRET_KEY: ${{ secrets.CLERK_SECRET_KEY }}

      - name: Deploy (OpenNext)
        run: |
          set -euxo pipefail

          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            npx @opennextjs/cloudflare deploy --config wrangler.jsonc --env production
            npx wrangler deployments list --config wrangler.jsonc --env production | head -n 30
          else
            npx @opennextjs/cloudflare deploy --config wrangler.jsonc --env staging
            npx wrangler deployments list --config wrangler.jsonc --env staging | head -n 30
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
